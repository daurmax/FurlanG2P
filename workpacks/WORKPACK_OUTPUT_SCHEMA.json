{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "workpacks/WORKPACK_OUTPUT_SCHEMA.json",
  "title": "Workpack Agent Handoff Output",
  "description": "Structured handoff produced by each agent after completing a prompt. Required for Workpack Protocol v2+. Extended in v4 with severity/iteration/B-series fields. Extended in v5 with execution cost tracking, repos, and structured change details.",
  "type": "object",
  "required": [
    "schema_version",
    "workpack",
    "prompt",
    "component",
    "delivery_mode",
    "branch",
    "changes",
    "verification",
    "handoff"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Schema version for this output payload.",
      "pattern": "^1\\.[0-9]+$",
      "examples": ["1.0"]
    },
    "workpack": {
      "type": "string",
      "description": "Workpack folder name (YYYY-MM-DD_<category>_<slug>).",
      "minLength": 5
    },
    "prompt": {
      "type": "string",
      "description": "Prompt basename without extension (e.g., A1_library, B1_library_oov_handling).",
      "minLength": 3
    },
    "component": {
      "type": "string",
      "description": "Affected component.",
      "enum": ["bootstrap", "library", "cli", "tests", "ml", "docs", "meta"]
    },
    "delivery_mode": {
      "type": "string",
      "description": "How changes are delivered.",
      "enum": ["pr", "direct_push"]
    },
    "branch": {
      "type": "object",
      "required": ["base", "work", "merge_target"],
      "properties": {
        "base": { "type": "string", "description": "Base branch name, typically main or feature root." },
        "work": { "type": "string", "description": "Working branch used by the agent." },
        "merge_target": { "type": "string", "description": "Branch the agent intends to merge into (feature root or main)." }
      },
      "additionalProperties": false
    },
    "artifacts": {
      "type": "object",
      "description": "Links to PRs, commits, or other artifacts.",
      "properties": {
        "pr_url": { "type": "string", "description": "PR URL if delivery_mode=pr." },
        "commit_shas": {
          "type": "array",
          "items": { "type": "string" },
          "description": "List of relevant commit SHAs."
        }
      },
      "additionalProperties": true
    },
    "changes": {
      "type": "object",
      "required": ["files_modified", "files_created", "contracts_changed", "breaking_change"],
      "properties": {
        "files_modified": { "type": "array", "items": { "type": "string" } },
        "files_created": { "type": "array", "items": { "type": "string" } },
        "contracts_changed": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Any API/DTO/schema contracts impacted (file paths or identifiers)."
        },
        "breaking_change": { "type": "boolean", "description": "True if a breaking change was introduced." }
      },
      "additionalProperties": true
    },
    "verification": {
      "type": "object",
      "required": ["commands"],
      "properties": {
        "commands": {
          "type": "array",
          "description": "Commands executed by the agent and outcomes.",
          "items": {
            "type": "object",
            "required": ["cmd", "result"],
            "properties": {
              "cmd": { "type": "string" },
              "result": { "type": "string", "enum": ["pass", "fail", "not_run"] },
              "notes": { "type": "string" }
            },
            "additionalProperties": false
          }
        },
        "regression_added": {
          "type": "boolean",
          "description": "True if a regression test/check was added (required for B-series when feasible)."
        },
        "regression_notes": {
          "type": "string",
          "description": "Where the regression lives and what it covers."
        }
      },
      "additionalProperties": true
    },
    "handoff": {
      "type": "object",
      "required": ["summary", "next_steps", "known_issues"],
      "properties": {
        "summary": { "type": "string", "description": "Short summary of what was done." },
        "next_steps": { "type": "array", "items": { "type": "string" } },
        "known_issues": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": true
    },
    "notes": { "type": "string" },
    "repos": {
      "type": "array",
      "description": "(v5) Repositories touched by this prompt (e.g. FurlanG2P).",
      "items": { "type": "string" }
    },
    "execution": {
      "type": "object",
      "description": "(v5) Cost and execution metrics for this prompt run.",
      "properties": {
        "model": { "type": "string", "description": "Model identifier used (e.g. claude-opus-4-20250514, gpt-4.1)." },
        "tokens_in": { "type": "integer", "description": "Approximate input tokens consumed.", "minimum": 0 },
        "tokens_out": { "type": "integer", "description": "Approximate output tokens produced.", "minimum": 0 },
        "duration_ms": { "type": "integer", "description": "Wall-clock duration in milliseconds.", "minimum": 0 }
      },
      "additionalProperties": true
    },
    "severity": {
      "type": ["string", "null"],
      "description": "(v4) Bug severity classification. Required for B-series prompts.",
      "enum": ["blocker", "major", "minor", null]
    },
    "iteration": {
      "type": "integer",
      "description": "(v4) V-loop iteration number. Starts at 1 for first verification run. Used by V2_bugfix_verify.",
      "minimum": 1
    },
    "b_series_resolved": {
      "type": "array",
      "description": "(v4) List of B-series prompt basenames confirmed resolved in this verification. Used by V2_bugfix_verify.",
      "items": { "type": "string" }
    },
    "b_series_remaining": {
      "type": "array",
      "description": "(v4) List of B-series prompt basenames still unresolved. Used by V2_bugfix_verify.",
      "items": { "type": "string" }
    },
    "b_series_budget_warning": {
      "type": "boolean",
      "description": "(v4) True if total B-series count exceeds budget threshold (>5). Used by V2_bugfix_verify.",
      "default": false
    },
    "change_details": {
      "type": "array",
      "description": "(v5) Structured per-file change details. Supplements the flat lists in changes.",
      "items": {
        "type": "object",
        "properties": {
          "repo": { "type": "string", "description": "Repository name." },
          "file": { "type": "string", "description": "Relative file path within the repo." },
          "action": { "type": "string", "enum": ["created", "modified", "deleted", "renamed"] },
          "lines_added": { "type": "integer", "minimum": 0 },
          "lines_removed": { "type": "integer", "minimum": 0 }
        },
        "required": ["repo", "file", "action"]
      }
    }
  },
  "additionalProperties": true
}
